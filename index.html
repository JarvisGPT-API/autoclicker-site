<script>
// ‚úÖ –¢–û–õ–¨–ö–û –°–õ–û–í–ê–†–ù–´–ï –°–õ–û–í–ê
const baseLevels = [
  { letters:["–ö","–û","–¢","–ê"], main:["–ö–û–¢","–¢–û–ö","–ê–¢–û","–û–ö–ê"] },
  { letters:["–î","–û","–ú","–ê"], main:["–î–û–ú","–û–î–ê","–ú–û–ê","–ú–û–î"] },
  { letters:["–õ","–ï","–°","–ê"], main:["–õ–ï–°","–°–ï–õ","–ê–°–ï","–°–ê–õ"] },
  { letters:["–†","–£","–ö","–ê"], main:["–†–£–ö–ê","–ö–ê–†","–£–†–ê","–ê–†–ö"] },
  { letters:["–ù","–û","–ì","–ê"], main:["–ù–û–ì–ê","–ì–û–ù","–ê–ù–û","–ê–ì–û"] }
];

// üîÅ 50 —É—Ä–æ–≤–Ω–µ–π
const levels=[];
while(levels.length<50){
  baseLevels.forEach(l=>{
    if(levels.length<50)
      levels.push(JSON.parse(JSON.stringify(l)));
  });
}

let level=+localStorage.level||0;
let coins=+localStorage.coins||0;
let skin=localStorage.skin||"default";

let current="",found=[],used=[],points=[],dragging=false;

const circle=document.getElementById("circle");
const svg=document.getElementById("lines");
const wordsDiv=document.getElementById("words");

document.getElementById("coins").textContent=coins;
document.body.className=skin==="neon"?"neon":"";

function save(){
  localStorage.level=level;
  localStorage.coins=coins;
  localStorage.skin=skin;
}

// üî¢ —Å–∫–æ–ª—å–∫–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–ª–æ–≤
function requiredCount(){
  return level < 9 ? 3 : 5;
}

function loadLevel(){
  circle.querySelectorAll(".letter").forEach(e=>e.remove());
  wordsDiv.innerHTML="";
  svg.innerHTML="";
  current="";found=[];used=[];points=[];
  document.getElementById("level").textContent=level+1;

  const L=levels[level].letters;
  const r=100;

  L.forEach((l,i)=>{
    const a=2*Math.PI/L.length*i;
    const d=document.createElement("div");
    d.className="letter";
    d.textContent=l;
    d.style.left=130+r*Math.cos(a)-28+"px";
    d.style.top =130+r*Math.sin(a)-28+"px";
    circle.appendChild(d);
  });

  const req = requiredCount();
  levels[level].main.forEach((w,i)=>{
    addWord(w, i >= req); // –ø–µ—Ä–≤—ã–µ req ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
  });
}

function addWord(w,bonus){
  const row=document.createElement("div");
  row.className="word"+(bonus?" bonus":"");
  row.dataset.word=w;
  row.dataset.bonus=bonus;
  for(let i=0;i<w.length;i++)
    row.appendChild(document.createElement("div")).className="cell";
  wordsDiv.appendChild(row);
}

circle.onpointerdown=e=>{dragging=true;check(e);}
circle.onpointermove=e=>dragging&&check(e);
document.onpointerup=()=>{dragging=false;checkWord();reset();}

function check(e){
  document.querySelectorAll(".letter").forEach(el=>{
    if(used.includes(el))return;
    const r=el.getBoundingClientRect();
    if(Math.hypot(e.clientX-(r.left+r.width/2),e.clientY-(r.top+r.height/2))<30){
      used.push(el);
      el.classList.add("active");
      current+=el.textContent;
      points.push({x:r.left+r.width/2,y:r.top+r.height/2});
      draw();
      document.getElementById("current").textContent=current;
    }
  });
}

function draw(){
  svg.innerHTML="";
  for(let i=1;i<points.length;i++){
    svg.innerHTML+=`<line x1="${points[i-1].x-circle.offsetLeft}"
    y1="${points[i-1].y-circle.offsetTop}"
    x2="${points[i].x-circle.offsetLeft}"
    y2="${points[i].y-circle.offsetTop}"
    stroke="#22c55e" stroke-width="6" stroke-linecap="round"/>`;
  }
}

function reset(){
  document.querySelectorAll(".letter").forEach(l=>l.classList.remove("active"));
  svg.innerHTML="";used=[];points=[];current="";
  document.getElementById("current").textContent="";
}

function checkWord(){
  document.querySelectorAll(".word").forEach(r=>{
    if(r.dataset.word===current && !found.includes(current)){
      found.push(current);
      coins+=current.length*(r.dataset.bonus==="true"?2:1);
      document.getElementById("coins").textContent=coins;
      [...r.children].forEach((c,i)=>c.textContent=current[i]);
      save();
    }
  });

  const requiredSolved =
    [...document.querySelectorAll(".word")]
      .filter(r=>r.dataset.bonus!=="true")
      .every(r=>found.includes(r.dataset.word));

  if(requiredSolved){
    level++; save();
    setTimeout(loadLevel,600);
  }
}

function shuffleLetters(){
  const letters=[...document.querySelectorAll(".letter")];
  const pos=letters.map(l=>({l:l.style.left,t:l.style.top}));
  pos.sort(()=>Math.random()-0.5);
  letters.forEach((l,i)=>{
    l.style.left=pos[i].l;
    l.style.top=pos[i].t;
  });
  reset();
}

function hint(){
  if(coins<5)return;
  coins-=5; save();
  document.getElementById("coins").textContent=coins;
  const r=[...document.querySelectorAll(".word")]
    .find(r=>![...r.children].every(c=>c.textContent));
  if(!r)return;
  const i=[...r.children].findIndex(c=>!c.textContent);
  r.children[i].textContent=r.dataset.word[i];
}

function openShop(){shop.style.display="block";}
function closeShop(){shop.style.display="none";}
function buyNeon(){if(coins>=20){coins-=20;skin="neon";save();location.reload();}}
function setSkin(s){skin=s;save();location.reload();}

loadLevel();
</script>
